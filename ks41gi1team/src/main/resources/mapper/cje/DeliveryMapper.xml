<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="k1.smart.team.mapper.cje.DeliveryMapper">

<!-- 운송요청내역 전체목록 조회 -->
<select id="getAllDeliveryList" parameterType="String" resultType="Delivery">
	SELECT 
		 RIGHT(d.deliveryCode,3) AS deliveryCode
		,RIGHT(d.shipmentPlanCode,3) AS shipmentPlanCode
		,RIGHT(c.contractCode,3) AS contractCode
		,c.clientCode
		,c.businessName AS clientBusinessName
		,d.deliveryBusinessCode
		,cl.businessName AS deliveryBusinessName
		,d.receiveAddr
		,d.deliveryCost
		,d.briefs
		,d.managerId
		,u.userName AS managerName
		,d.updateDate
	FROM
		k1_tb_delivery AS d
		LEFT JOIN
		k1_tb_shipment_plan AS s
		ON
		d.shipmentPlanCode = s.shipmentPlanCode
		LEFT JOIN
		(SELECT
			 c.contractCode
			,c.clientCode
			,cl.businessName
		FROM
			k1_tb_contract AS c
			JOIN
			k1_tb_client AS cl
			ON
			c.clientCode = cl.clientCode
		) AS c
		ON
		s.contractCode = c.contractCode
		LEFT JOIN
		k1_tb_client AS cl
		ON
		d.deliveryBusinessCode = cl.clientCode
		JOIN
		k1_tb_user AS u
		ON
		d.managerId = u.userId
	WHERE
		d.mainBusinessCode = #{mainBusinessCode};
</select>

<select id="getDeliveryInfo" parameterType="String" resultType="Delivery">
	SELECT 
		 RIGHT(d.deliveryCode,3) AS deliveryCode
		,RIGHT(d.shipmentPlanCode,3) AS shipmentPlanCode
		,RIGHT(d.returnRegCode,3) AS returnRegCode
		,d.deliveryBusinessCode
		,c.businessName AS deliveryBusinessName
		,RIGHT(s.contractCode,3) AS contractCode
		,s.clientCode
		,s.businessName AS clientBusinessName
		,d.receiveAddr
		,a.stockAdjCode
		,a.stockReasonCode
		,a.stockReason
		,a.warehouseCode
		,a.warehouseName
		,a.loaction
		,a.outPlace
		,d.deliveryCost
		,d.briefs
		,d.managerId
		,u.userName AS managerName
		,d.regDate
		,d.updateDate
	FROM 
		k1_tb_delivery AS d
		JOIN
		k1_tb_user AS u
		ON
		d.managerId = u.userId
		LEFT JOIN
		(SELECT
			 s.shipmentPlanCode
			,s.contractCode
			,c.clientCode
			,cl.businessName
		FROM
			k1_tb_shipment_plan AS s
			JOIN
			k1_tb_contract AS c
			ON
			s.contractCode = c.contractCode
			JOIN
			k1_tb_client AS cl
			ON
			c.clientCode = cl.clientCode
		) AS s
		ON
		d.shipmentPlanCode = s.shipmentPlanCode
		JOIN
		k1_tb_client AS c
		ON
		d.deliveryBusinessCode = c.clientCode
		LEFT JOIN
		(SELECT
			 a.deliveryCode
			,RIGHT(a.stockAdjCode,3) AS stockAdjCode
			,a.stockReasonCode
			,r.reason AS stockReason
			,RIGHT(a.sendWarehouse,3) AS warehouseCode
			,w.warehouseName
			,w.loaction
			,w.outPlace
		FROM
			k1_tb_stock_adjustment AS a
			JOIN
			k1_tb_stock_reason AS r
			ON
			a.stockReasonCode = r.stockReasonCode
			JOIN
			k1_tb_warehouse_info AS w
			ON
			a.sendWarehouse = w.warehouseCode
		) AS a
		ON
		d.deliveryCode = a.deliveryCode
	WHERE
		d.mainBusinessCode = #{mainBusinessCode}
		AND d.deliveryCode = CONCAT('deliveryCode_',#{deliveryCode});
</select>

</mapper>