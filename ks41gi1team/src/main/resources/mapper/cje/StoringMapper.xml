<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="k1.smart.team.mapper.cje.StoringMapper">

<!-- 물류이동내역(전체목록) -->
<select id="getAllStoringList" parameterType="String" resultType="Storing">
	SELECT 
		 RIGHT(a.stockAdjCode,3) AS stockAdjCode
		,a.stockReasonCode
		,r.reason AS stockReason
		,a.clientCode
		,c.businessName
		,GROUP_CONCAT(DISTINCT ad.itemName SEPARATOR ', ') AS itemList
		,a.totalPrice
		,a.briefs
		,a.requestDate
		,a.adjDate
		,a.endDate
		,a.managerId
		,u.userName AS managerName
		,a.regDate
		,LEFT(a.updateDate,10) AS updateDate
	FROM 
		k1_tb_stock_adjustment AS a
		JOIN
		k1_tb_stock_reason AS r
		ON
		a.stockReasonCode = r.stockReasonCode
		JOIN
		k1_tb_user AS u
		ON
		a.managerId = u.userId
		JOIN
		(SELECT
			 ad.stockAdjDetailCode
			,ad.stockAdjCode
			,s.inventoryCode
			,i.itemName
		FROM
			k1_tb_stock_adjustment_detail AS ad
			JOIN
			k1_tb_stock AS s
			ON
			ad.inventoryCode = s.inventoryCode
			JOIN
			k1_tb_item_info AS i
			ON
			s.itemCode = i.itemCode
		) AS ad
		ON
		a.stockAdjCode = ad.stockAdjCode
		LEFT JOIN
		k1_tb_client AS c
		ON
		a.clientCode= c.clientCode
	<trim prefix="WHERE" prefixOverrides="AND |OR ">
		<if test="mainBusinessCode != null and mainBusinessCode != ''.toString()">
			a.mainBusinessCode = #{mainBusinessCode}
		</if>
		<if test="stockReasonCode != null and stockReasonCode != ''.toString()">
			AND a.stockReasonCode = ${stockReasonCode}
		</if>
	</trim>
	GROUP BY a.stockAdjCode;
</select>

<!-- 최근 7일간 물류이동 횟수(사유별) -->
<select id="getRecentStoring" parameterType="String" resultType="Map">
	SELECT
		 s1.s1_Warehousing
		,s2.s2_MaterialUse
		,s3.s3_Production
		,s4.s4_Moving
		,s5.s5_Shipment
		,s6.s6_Adjustment
		,s7.s7_Return
		,s8.s8_Defect
	FROM
		(SELECT
			COUNT(*) AS s1_Warehousing
		FROM k1_tb_stock_adjustment AS s1
		WHERE
			s1.mainBusinessCode = #{mainBusinessCode}
			AND adjDate > SUBDATE(CURDATE(), 7)
			AND stockReasonCode = 1
		) AS s1
		JOIN
		(SELECT
			COUNT(*) AS s2_MaterialUse
		FROM k1_tb_stock_adjustment AS s2
		WHERE
			s2.mainBusinessCode = #{mainBusinessCode}
			AND adjDate > SUBDATE(CURDATE(), 7)
			AND stockReasonCode = 2
		) AS s2
		JOIN
		(SELECT
			COUNT(*) AS s3_Production
		FROM k1_tb_stock_adjustment AS s3
		WHERE
			s3.mainBusinessCode = #{mainBusinessCode}
			AND adjDate > SUBDATE(CURDATE(), 7)
			AND stockReasonCode = 3
		) AS s3
		JOIN
		(SELECT
			COUNT(*) AS s4_Moving
		FROM k1_tb_stock_adjustment AS s4
		WHERE
			s4.mainBusinessCode = #{mainBusinessCode}
			AND adjDate > SUBDATE(CURDATE(), 7)
			AND stockReasonCode = 4
		) AS s4
		JOIN
		(SELECT
			COUNT(*) AS s5_Shipment
		FROM k1_tb_stock_adjustment AS s5
		WHERE
			s5.mainBusinessCode = #{mainBusinessCode}
			AND adjDate > SUBDATE(CURDATE(), 7)
			AND stockReasonCode = 5
		) AS s5
		JOIN
		(SELECT
			COUNT(*) AS s6_Adjustment
		FROM k1_tb_stock_adjustment AS s6
		WHERE
			s6.mainBusinessCode = #{mainBusinessCode}
			AND adjDate > SUBDATE(CURDATE(), 7)
			AND stockReasonCode = 6
		) AS s6
		JOIN
		(SELECT
			COUNT(*) AS s7_Return
		FROM k1_tb_stock_adjustment AS s7
		WHERE
			s7.mainBusinessCode = #{mainBusinessCode}
			AND adjDate > SUBDATE(CURDATE(), 7)
			AND stockReasonCode = 7
		) AS s7
		JOIN
		(SELECT
			COUNT(*) AS s8_Defect
		FROM k1_tb_stock_adjustment AS s8
		WHERE
			s8.mainBusinessCode = #{mainBusinessCode}
			AND adjDate > SUBDATE(CURDATE(), 7)
			AND stockReasonCode = 8
		) AS s8;
</select>

<!-- 물류이동내역 한줄 -->
<select id="getStoringInfo" parameterType="String" resultType="Storing">
	SELECT 
		 RIGHT(a.stockAdjCode,3) AS stockAdjCode
		,RIGHT(a.shipmentPlanCode,3) AS shipmentPlanCode
		,RIGHT(a.returnRegCode,3) AS returnRegCode
		,a.clientCode
		,c.businessName
		,RIGHT(a.contractCode,3) AS contractCode
		,RIGHT(a.sendWarehouse,3) AS sendWarehouse
		,w1.warehouseName AS sendWarehouseName
		,w1.location AS sendWarehouseLocation
		,w1.outPlace AS sendWarehouseOutPlace
		,RIGHT(a.receiveWarehouse,3) AS receiveWarehouse
		,w2.warehouseName AS receiveWarehouseName
		,w2.location AS receiveWarehouseLocation
		,w2.outPlace AS receiveWarehouseOutPlace
		,a.totalPrice
		,a.totalWeight
		,RIGHT(a.materialOrderCode,3) AS materialOrderCode
		,RIGHT(a.productOrderCode,3) AS productOrderCode
		,a.deliveryCost
		,RIGHT(a.deliveryCode,3) AS deliveryCode
		,a.briefs
		,a.managerId
		,u.userName AS managerName
		,a.requestDate
		,a.adjDate
		,a.endDate
		,a.regDate
		,a.updateDate
	FROM 
		k1_tb_stock_adjustment AS a
		JOIN
		k1_tb_user AS u
		ON
		a.managerId = u.userId
		LEFT JOIN
		k1_tb_client AS c
		ON
		a.clientCode = c.clientCode
		LEFT JOIN
		k1_tb_warehouse_info AS w1
		ON
		a.sendWarehouse = w1.warehouseCode
		LEFT JOIN
		k1_tb_warehouse_info AS w2
		ON
		a.receiveWarehouse = w2.warehouseCode
	WHERE
		a.mainBusinessCode = #{mainBusinessCode}
		AND a.stockAdjCode = CONCAT('stockAdjCode_',#{stockAdjCode})
		AND a.stockReasonCode = ${stockReasonCode};
</select>

<!-- 1. 자재입고내역 상세(목록) -->
<select id="getWarehousingDetails" parameterType="String" resultType="Storing">
	SELECT
		 RIGHT(ad.stockAdjDetailCode,3) AS stockAdjDetailCode
		,RIGHT(ad.inventoryCode,3) AS inventoryCode
		,i.itemName
		,RIGHT(ad.purchaseTsCode,3) AS purchaseTsCode
		,p.unitPrice
		,ad.adjCount
		,ad.afterCount
		,ad.adjWeight
		,ad.stockWeight
		,ad.stockStatus
		,ad.`comment`
	FROM
		k1_tb_stock_adjustment AS a
		JOIN
		k1_tb_stock_adjustment_detail AS ad
		ON
		a.stockAdjCode = ad.stockAdjCode
		JOIN
		(SELECT
			 s.inventoryCode
			,s.itemCode
			,i.itemName
		FROM
			k1_tb_item_info AS i
			JOIN
			k1_tb_stock AS s
			ON
			i.itemCode = s.itemCode
		) AS i
		ON
		ad.inventoryCode = i.inventoryCode
		LEFT JOIN
		(SELECT
			 p.purchaseTsCode
			,pd.unitPrice
		FROM
			k1_tb_purchase_transaction AS p
			JOIN
			k1_tb_purchase_transaction_detail AS pd
			ON
			p.purchaseTsCode = pd.purchaseTsCode
		) AS p
		ON
		ad.purchaseTsCode = p.purchaseTsCode
	WHERE
		a.stockAdjCode = CONCAT('stockAdjCode_', #{stockAdjCode})
		AND a.stockReasonCode = 1;
</select>

<!-- 2. 자재사용내역 상세(목록) -->
<select id="getMaterialUseDetails" parameterType="String" resultType="Storing">
	SELECT
		 RIGHT(ad.stockAdjDetailCode,3) AS stockAdjDetailCode
		,RIGHT(ad.inventoryCode,3) AS inventoryCode
		,RIGHT(ad.purchaseTsCode,3) AS purchaseTsCode
		,p.unitPrice
		,i.itemName
		,ad.adjCount
		,ad.afterCount
		,ad.adjWeight
		,ad.stockWeight
		,ad.stockStatus
		,ad.`comment`
	FROM
		k1_tb_stock_adjustment AS a
		JOIN
		k1_tb_stock_adjustment_detail AS ad
		ON
		a.stockAdjCode = ad.stockAdjCode
		JOIN
		(SELECT
			 s.inventoryCode
			,s.itemCode
			,i.itemName
		FROM
			k1_tb_item_info AS i
			JOIN
			k1_tb_stock AS s
			ON
			i.itemCode = s.itemCode
		) AS i
		ON
		ad.inventoryCode = i.inventoryCode
		LEFT JOIN
		(SELECT
			 p.purchaseTsCode
			,pd.unitPrice
			,pd.itemCode
		FROM
			k1_tb_purchase_transaction AS p
			JOIN
			k1_tb_purchase_transaction_detail AS pd
			ON
			p.purchaseTsCode = pd.purchaseTsCode
		) AS p
		ON
		ad.purchaseTsCode = p.purchaseTsCode
		AND i.itemCode = p.itemCode
	WHERE
		a.stockAdjCode = CONCAT('stockAdjCode_', #{stockAdjCode})
		AND a.stockReasonCode = 2;
</select>

<!-- 3. 제품생산내역 상세(목록) -->
<select id="getProductionDetails" parameterType="String" resultType="Storing">
	SELECT
		 RIGHT(ad.stockAdjDetailCode,3) AS stockAdjDetailCode
		,RIGHT(ad.inventoryCode,3) AS inventoryCode
		,i.itemName
		,ad.adjCount
		,ad.afterCount
		,ad.adjWeight
		,ad.stockWeight
		,ad.stockStatus
		,ad.`comment`
	FROM
		k1_tb_stock_adjustment AS a
		JOIN
		k1_tb_stock_adjustment_detail AS ad
		ON
		a.stockAdjCode = ad.stockAdjCode
		JOIN
		(SELECT
			 s.inventoryCode
			,s.itemCode
			,i.itemName
		FROM
			k1_tb_item_info AS i
			JOIN
			k1_tb_stock AS s
			ON
			i.itemCode = s.itemCode
		) AS i
		ON
		ad.inventoryCode = i.inventoryCode
	WHERE
		a.stockAdjCode = CONCAT('stockAdjCode_', #{stockAdjCode})
		AND a.stockReasonCode = 3;
</select>

<!-- 4. 창고이동내역 상세(목록) -->
<select id="getMovingDetails" parameterType="String" resultType="Storing">
	SELECT
		 RIGHT(ad.stockAdjDetailCode,3) AS stockAdjDetailCode
		,RIGHT(ad.inventoryCode,3) AS inventoryCode
		,i.itemName
		,ad.adjCount
		,ad.afterCount
		,ad.adjWeight
		,ad.stockWeight
		,ad.stockStatus
		,ad.`comment`
	FROM
		k1_tb_stock_adjustment AS a
		JOIN
		k1_tb_stock_adjustment_detail AS ad
		ON
		a.stockAdjCode = ad.stockAdjCode
		JOIN
		(SELECT
			 s.inventoryCode
			,s.itemCode
			,i.itemName
		FROM
			k1_tb_item_info AS i
			JOIN
			k1_tb_stock AS s
			ON
			i.itemCode = s.itemCode
		) AS i
		ON
		ad.inventoryCode = i.inventoryCode
	WHERE
		a.stockAdjCode = CONCAT('stockAdjCode_', #{stockAdjCode})
		AND a.stockReasonCode = 4;
</select>

<!-- 5. 출하내역 상세(목록) -->
<select id="getShipmentDetails" parameterType="String" resultType="Storing">
	SELECT
		 RIGHT(ad.stockAdjDetailCode,3) AS stockAdjDetailCode
		,RIGHT(ad.inventoryCode,3) AS inventoryCode
		,i.itemName
		,RIGHT(ad.salesTsCode, 3) AS salesTsCode
		,ad.adjCount
		,ad.afterCount
		,ad.adjWeight
		,ad.stockWeight
		,ad.stockStatus
		,ad.`comment`
	FROM
		k1_tb_stock_adjustment AS a
		JOIN
		k1_tb_stock_adjustment_detail AS ad
		ON
		a.stockAdjCode = ad.stockAdjCode
		JOIN
		(SELECT
			 s.inventoryCode
			,s.itemCode
			,i.itemName
		FROM
			k1_tb_item_info AS i
			JOIN
			k1_tb_stock AS s
			ON
			i.itemCode = s.itemCode
		) AS i
		ON
		ad.inventoryCode = i.inventoryCode
	WHERE
		a.stockAdjCode = CONCAT('stockAdjCode_', #{stockAdjCode})
		AND a.stockReasonCode = 5;
</select>

<!-- 6. 재고차이조정내역 상세(목록) -->
<select id="getAdjDetails" parameterType="String" resultType="Storing">
	SELECT
		 RIGHT(ad.stockAdjDetailCode,3) AS stockAdjDetailCode
		,RIGHT(ad.inventoryCode,3) AS inventoryCode
		,RIGHT(i.itemCode,3) AS itemCode
		,i.itemName
		,RIGHT(ad.purchaseTsCode,3) AS purchaseTsCode
		,RIGHT(ad.salesTsCode,3) AS salesTsCode
		,ad.adjCount
		,ad.afterCount
		,ad.adjWeight
		,ad.stockWeight
		,ad.stockStatus
		,ad.`comment`
	FROM
		k1_tb_stock_adjustment AS a
		JOIN
		k1_tb_stock_adjustment_detail AS ad
		ON
		a.stockAdjCode = ad.stockAdjCode
		JOIN
		(SELECT
			 s.inventoryCode
			,s.itemCode
			,i.itemName
		FROM
			k1_tb_item_info AS i
			JOIN
			k1_tb_stock AS s
			ON
			i.itemCode = s.itemCode
		) AS i
		ON
		ad.inventoryCode = i.inventoryCode
	WHERE
		a.stockAdjCode = CONCAT('stockAdjCode_',#{stockAdjCode})
		AND a.stockReasonCode = 6;
</select>

<!-- 7. 반품처리내역 상세(목록) -->
<select id="getReturnDetails" parameterType="String" resultType="Storing">
	SELECT
		 RIGHT(ad.stockAdjDetailCode,3) AS stockAdjDetailCode
		,RIGHT(ad.inventoryCode,3) AS inventoryCode
		,i.itemName
		,ad.adjCount
		,ad.afterCount
		,ad.adjWeight
		,ad.stockWeight
		,RIGHT(ad.purchaseTsCode,3 ) AS purchaseTsCode
		,RIGHT(ad.salesTsCode, 3) AS salesTsCode
		,ad.stockStatus
		,ad.defectType
		,ad.defectHandlingType
		,ad.`comment`
	FROM
		k1_tb_stock_adjustment AS a
		JOIN
		k1_tb_stock_adjustment_detail AS ad
		ON
		a.stockAdjCode = ad.stockAdjCode
		JOIN
		(SELECT
			 s.inventoryCode
			,s.itemCode
			,i.itemName
		FROM
			k1_tb_item_info AS i
			JOIN
			k1_tb_stock AS s
			ON
			i.itemCode = s.itemCode
		) AS i
		ON
		ad.inventoryCode = i.inventoryCode
	WHERE
		a.stockAdjCode = CONCAT('stockAdjCode_', #{stockAdjCode})
		AND a.stockReasonCode = 7;
</select>

<!-- 8. 불량처리내역 상세(목록) -->
<select id="getDefectDetails" parameterType="String" resultType="Storing">
	SELECT
		 RIGHT(ad.stockAdjDetailCode,3) AS stockAdjDetailCode
		,RIGHT(ad.inventoryCode,3) AS inventoryCode
		<!-- ,RIGHT(i.itemCode,3) AS itemCode -->
		,i.itemName
		,ad.adjCount
		,ad.afterCount
		,ad.adjWeight
		,ad.stockWeight
		,ad.stockStatus
		,ad.defectType
		,ad.defectHandlingType
		,ad.`comment`
	FROM
		k1_tb_stock_adjustment AS a
		JOIN
		k1_tb_stock_adjustment_detail AS ad
		ON
		a.stockAdjCode = ad.stockAdjCode
		JOIN
		(SELECT
			 s.inventoryCode
			,s.itemCode
			,i.itemName
		FROM
			k1_tb_item_info AS i
			JOIN
			k1_tb_stock AS s
			ON
			i.itemCode = s.itemCode
		) AS i
		ON
		ad.inventoryCode = i.inventoryCode
	WHERE
		a.stockAdjCode = CONCAT('stockAdjCode_',#{stockAdjCode})
		AND a.stockReasonCode = 8;
</select>

<!-- 출하계획 전체조회 -->
<select id="getShipmentPlanList" parameterType="String" resultType="Storing">
	SELECT 
		 RIGHT(sp.shipmentPlanCode,3) AS shipmentPlanCode
		,RIGHT(sp.contractCode,3) AS contractCode
		,c.clientCode
		,c.businessName AS businessName
		,sp.receiveAddr
		,sp.planDate AS sendPlanDate
		,sp.briefs
		,sp.managerId
		,u.userName AS managerName
		,LEFT(sp.updateDate,10) AS updateDate
	FROM 
		k1_tb_shipment_plan AS sp
		JOIN
		k1_tb_user AS u
		ON
		sp.managerId = u.userId
		LEFT JOIN
		(SELECT
			 c.contractCode
			,c.clientCode
			,cl.businessName
		FROM
			k1_tb_contract AS c
			JOIN
			k1_tb_client AS cl
			ON
			c.clientCode = cl.clientCode
		) AS c
		ON
		sp.contractCode = c.contractCode
	WHERE
		sp.mainBusinessCode = #{mainBusinessCode};
</select>

<!-- 출하계획 상세조회 -->
<select id="getShipmentPlanInfo" parameterType="String" resultType="Storing">
	SELECT 
		 RIGHT(sp.shipmentPlanCode,3) AS shipmentPlanCode
		,RIGHT(sp.contractCode,3) AS contractCode
		,c.clientCode
		,c.businessName AS businessName
		,sp.receiveAddr
		,sp.planDate AS sendPlanDate
		,sp.briefs
		,sp.managerId
		,u.userName AS managerName
		,sp.regDate
		,sp.updateDate
	FROM 
		k1_tb_shipment_plan AS sp
		JOIN
		k1_tb_user AS u
		ON
		sp.managerId = u.userId
		LEFT JOIN
		(SELECT
			 c.contractCode
			,c.clientCode
			,cl.businessName
		FROM
			k1_tb_contract AS c
			JOIN
			k1_tb_client AS cl
			ON
			c.clientCode = cl.clientCode
		) AS c
		ON
		sp.contractCode = c.contractCode
	WHERE
		sp.mainBusinessCode = #{mainBusinessCode}
		AND sp.shipmentPlanCode = CONCAT('shipmentPlanCode_',#{shipmentPlanCode});
</select>
<select id="getShipmentPlanDetails" parameterType="String" resultType="Storing">
	SELECT
		 RIGHT(sd.inventoryCode,3) AS inventoryCode
		,RIGHT(st.itemCode,3) AS itemCode
		,st.itemName
		,RIGHT(st.productPriceCode,3) AS productPriceCode
		,st.productPrice AS unitPrice
		,RIGHT(st.warehouseCode,3) AS warehouseCode
		,st.warehouseName
		,st.location
		,st.outPlace
		,sd.itemCount AS adjCount
		,sd.itemWeight AS adjWeight
		,sd.totalPrice
		,sd.`comment`
	FROM
		k1_tb_shipment_plan_detail AS sd
		JOIN
		k1_tb_shipment_plan AS sp
		ON
		sd.shipmentPlanCode = sp.shipmentPlanCode
		JOIN
		(SELECT
			 s.inventoryCode
			,s.itemCode
			,i.itemName
			,s.productPriceCode
			,p.productPrice
			,s.warehouseCode
			,w.warehouseName
			,w.location
			,w.outPlace
		FROM
			k1_tb_stock AS s
			JOIN
			k1_tb_item_info AS i
			ON
			s.itemCode = i.itemCode
			JOIN
			k1_tb_warehouse_info AS w
			ON
			s.warehouseCode = w.warehouseCode
			LEFT JOIN
			k1_tb_product_price AS p
			ON
			s.productPriceCode = p.productPriceCode
		) AS st
		ON
		sd.inventoryCode = st.inventoryCode
	WHERE
		sp.shipmentPlanCode = CONCAT('shipmentPlanCode_',#{shipmentPlanCode});
</select>

<!-- 반품요청내역 전체목록 -->
<select id="getReturnRegList" parameterType="String" resultType="Storing">
	SELECT 
		 RIGHT(r.returnRegCode,3) AS returnRegCode
		,r.clientCode
		,c.businessName
		,r.totalPrice
		,r.briefs
		,r.managerId
		,i.userName AS managerName
		,LEFT(r.updateDate,10) AS updateDate
	FROM 
		k1_tb_return_reg AS r
		JOIN 
		k1_tb_user AS i
		ON 
		r.managerId = i.userId
		JOIN
		k1_tb_client AS c
		ON
		r.clientCode = c.clientCode
	WHERE
		r.mainBusinessCode = #{mainBusinessCode};
</select>

<!-- 반품요청내역 상세정보(날짜) -->
<select id="getReturnRegInfo" parameterType="String" resultType="Storing">
	SELECT 
		 RIGHT(r.returnRegCode,3) AS returnRegCode
		,r.clientCode
		,c.businessName
		,RIGHT(r.purchaseTsCode,3) AS purchaseTsCode
		,RIGHT(pt.contractCode,3) AS contractCode
		,RIGHT(r.salesTsCode,3) AS salesTsCode
		,RIGHT(st.contractCode,3) AS contractCode
		,r.totalPrice
		,r.briefs
		,r.managerId
		,i.userName AS managerName
		,r.regDate
		,r.updateDate
	FROM 
		k1_tb_return_reg AS r
		JOIN 
		k1_tb_user AS i
		ON 
		r.managerId = i.userId
		JOIN
		k1_tb_client AS c
		ON
		r.clientCode = c.clientCode
		LEFT JOIN
		k1_tb_purchase_transaction AS pt
		ON
		r.purchaseTsCode = pt.purchaseTsCode
		LEFT JOIN
		k1_tb_sales_transaction AS st
		ON
		r.salesTsCode = st.salesTsCode
	WHERE
		r.returnRegCode = CONCAT('returnRegCode_',#{returnRegCode});
</select>
<!-- 반품요청내역 상세정보 목록 -->
<select id="getReturnRegDetails" parameterType="String" resultType="Storing">
	SELECT
		 RIGHT(d.itemCode,3) AS itemCode
		,i.itemName
		,d.amount
		,d.`count` AS adjCount
		,(d.amount * d.`count`) AS totalPrice
		,d.`comment`
	FROM 
		k1_tb_return_reg_detail AS d
		JOIN
		k1_tb_item_info AS i
		ON
		d.itemCode = i.itemCode
	WHERE
		d.returnRegCode = CONCAT('returnRegCode_',#{returnRegCode});
</select>

</mapper>