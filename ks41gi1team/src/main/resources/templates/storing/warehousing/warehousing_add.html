<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="@{layout/default}">

<th:block layout:fragment="customTitle">
	<title>[[${SectionLocation}]]</title>
</th:block>
<th:block layout:fragment="customCss"></th:block>
<th:block layout:fragment="customJs">
<script type="text/javascript">
$(function(){
	/****************************
				플러그인
	****************************/
	//datetimepicker
	$('#requestDate').datetimepicker({ format: 'yy-mm-DD' });
	$('#adjDate').datetimepicker({ format: 'yy-mm-DD' });
	$('#endDate').datetimepicker({ format: 'yy-mm-DD' });
	
	
	/****************************
				객체정의
	****************************/
	//SweetAlert
	var Toast = Swal.mixin({
		toast: true,
		position: 'top-end',
		showConfirmButton: false,
		timer: 3000
	});
	//form 객체
	var addWarehousing = $('#addWarehousing');
	//input 객체 - 한줄내역
	var clientCode = $('#clientCode'); //거래처코드
	var businessName = $('#businessName'); //거래처명
	var materialOrderCode = $('#materialOrderCode'); //자재발주코드
	var contractCode = $('#contractCode'); //계약코드
	var receiveWarehouse = $('#receiveWarehouse'); //받는창고
	var receiveWarehouseName = $('#receiveWarehouseName'); //창고명
	var receiveWarehouseLocation = $('#receiveWarehouseLocation'); //창고위치
	var totalWeight = $('#totalWeight'); //합계중량
	var totalPrice = $('#totalPrice'); //합계금액
	var itemListInput = $('#itemListInput'); //자재목록
	var briefs = $('#briefs'); //적요
	var managerId = $('#managerId'); //담당자ID
	var managerName = $('#managerName'); //담당자이름
	var requestDate= $('input[name="requestDate"]'); //요청일자
	//상세내역
	var details = $('#details'); //상세구역
	var detailrow = $('#details .row:first-of-type'); //한줄
	//모달
	var modalObj = $('#modalObj'); //모달창
	var modalTitle = $('#modalObj .modal-title'); //모달창 제목
	var modalBody = $('#modalObj .modal-body'); //모달창 body
	
	//날짜입력칸에 현재날짜 default
	var dateObj = new Date();
	var dateToday = dateObj.getFullYear()+'-';//연
	if(dateObj.getMonth()+1<10){
		dateToday += '0';
	}
	dateToday += dateObj.getMonth()+1;//월
	dateToday += '-';
	if(dateObj.getDate()<10){
		dateToday += '0';
	}
	dateToday += dateObj.getDate();//일
	$('.date').find('input').val(dateToday);

	
	/****************************
				자동화
	****************************/
	
	//상세내역 폼 추가
	$(document).on('click', '#addLine', function(){
		var clone = detailrow.clone();
		clone.find('input').val(null);
		details.append(clone);
	});
	//상세내역 폼 삭제
	$(document).on('click', '.removeLine', function(){
		$(this).parents('#details .row').remove();
		//품목목록 join
		var itemNames = [];
		$('#details input.itemNameForm').each(function(i, obj){
			if($(obj).val() == '') {
				return true;
			}
			itemNames.push($(obj).val());
		});
		itemListInput.val(itemNames.join(', '));
		//합계중량
		var sum=0;
		$('input[name="stockWeight"]').each(function(i, obj){
			sum += Number($(obj).val());
		});
		totalWeight.val(sum);
		//합계금액
		sum=0;
		$('input.unitPriceForm').each(function(i, obj){
			sum += Number( $(obj).val() ) * Number( $(obj).parents('#details .row').find('input[name="itemCount"]').val() );
		});
		totalPrice.val(sum);
	});
	
	//품목 목록 join string
	$(document).on('change', '#details input.itemNameForm', function(){
		var itemNames = [];
		$('#details input.itemNameForm').each(function(i, obj){
			if($(obj).val() == '') {
				return true;
			}
			itemNames.push($(obj).val());
		});
		itemListInput.val(itemNames.join(', '));
	});
	
	//합계중량 구하기
	$(document).on('change', 'input[name="stockWeight"]', function(){
		var sum=0;
		$('input[name="stockWeight"]').each(function(i, obj){
			sum += Number($(obj).val());
		});
		totalWeight.val(sum);
	});
	//합계금액 구하기
	$(document).on('change', 'input[name="itemCount"], input.unitPriceForm', function(){
		var sum=0;
		$('input.unitPriceForm').each(function(i, obj){
			sum += Number( $(obj).val() ) * Number( $(obj).parents('#details .row').find('input[name="itemCount"]').val() );
		});
		totalPrice.val(sum);
	});
	
	
	/****************************
				Modal
	****************************/
	//거래처 Modal
	$(document).on('click', '#businessName', function(){
		//초기화
		materialOrderCode.val(null);
		contractCode.val(null);
		clientCode.val(null);
		businessName.val(null);
		//ajax
		$.ajax({
			url: "/clientListModal",
			method: "GET",
			dataType: "html"
		})
		.done(function( data ) {
			modalTitle.text('거래처정보');
			//modal body 삽입
			modalBody.html(data);
			//DataTable plugin 적용
			$('#clientList').DataTable({
		        "paging": true,
		        "lengthChange": false,
		        "searching": true,
		        "ordering": true,
		        "info": true,
		        "autoWidth": false,
		        "responsive": true,
			});
			modalObj.modal('show');
		})
		.fail(function( jqXHR, textStatus ) {
			Toast.fire({
				icon: 'warning',
				title: "Request failed: " + textStatus
			});
		});
	});
	
	//계약내역 Modal
	$(document).on('click', '#contractCode', function(){
		//초기화
		materialOrderCode.val(null);
		contractCode.val(null);
		clientCode.val(null);
		businessName.val(null);
		
	});
	
	//자재발주내역 Modal
	$(document).on('click', '#materialOrderCode', function(){
		//초기화
		materialOrderCode.val(null);
		contractCode.val(null);
		clientCode.val(null);
		businessName.val(null);
		//ajax
		$.ajax({
			url: "/materialOrderListModal",
			method: "GET",
			dataType: "html"
		})
		.done(function( data ) {
			modalTitle.text('자재발주내역');
			//modal body 삽입
			modalBody.html(data);
			//DataTable plugin 적용
			$('#materialOrderList').DataTable({
		        "paging": true,
		        "lengthChange": false,
		        "searching": true,
		        "ordering": true,
		        "info": true,
		        "autoWidth": false,
		        "responsive": true,
			});
			modalObj.modal('show');
		})
		.fail(function( jqXHR, textStatus ) {
			Toast.fire({
				icon: 'warning',
				title: "Request failed: " + textStatus
			});
		});
	});
	
	//창고목록 Modal
	$(document).on('click', '#receiveWarehouseName', function(){
		//초기화
		receiveWarehouse.val(null);
		receiveWarehouseName.val(null);
		receiveWarehouseLocation.val(null);
		//ajax
		$.ajax({
			url: "/warehouseListModal",
			method: "GET",
			dataType: "html"
		})
		.done(function( data ) {
			modalTitle.text('창고정보');
			//modal body 삽입
			modalBody.html(data);
			//DataTable plugin 적용
			$('#warehouseList').DataTable({
		        "paging": true,
		        "lengthChange": false,
		        "searching": true,
		        "ordering": true,
		        "info": true,
		        "autoWidth": false,
		        "responsive": true,
			});
			modalObj.modal('show');
		})
		.fail(function( jqXHR, textStatus ) {
			Toast.fire({
				icon: 'warning',
				title: "Request failed: " + textStatus
			});
		});
	});
	
	//회원정보 Modal
	$(document).on('click', '#managerName', function(){
		//초기화
		managerId.val(null);
		managerName.val(null);
		//ajax
		$.ajax({
			url: "/userListModal",
			method: "GET",
			dataType: "html"
		})
		.done(function( data ) {
			modalTitle.text('회원정보');
			//modal body 삽입
			modalBody.html(data);
			//DataTable plugin 적용
			$('#userList').DataTable({
		        "paging": true,
		        "lengthChange": false,
		        "searching": true,
		        "ordering": true,
		        "info": true,
		        "autoWidth": false,
		        "responsive": true,
			});
			modalObj.modal('show');
		})
		.fail(function( jqXHR, textStatus ) {
			Toast.fire({
				icon: 'warning',
				title: "Request failed: " + textStatus
			});
		});
	});
	
	//품목정보 Modal
	$(document).on('click', '#details .itemNameForm', function(){
		//초기화
		$('#details .itemNameForm').removeClass('pickIForm'); //pick표시 해제
		$(this).parents('.row').find('input[name="itemCode"]').val(null); //품목코드
		$(this).val(null); //품목명
		$(this).parents('.row').find('input[name="purchaseTsCode"]').val(null); //비용 거래명세서 코드
		$(this).parents('.row').find('input.unitPriceForm').val(null); //자재단가
		//pick표시
		$(this).addClass('pickIForm');
		//ajax
		$.ajax({
			url: "/itemListModal",
			method: "GET",
			dataType: "html"
		})
		.done(function( data ) {
			modalTitle.text('품목정보');
			//modal body 삽입
			modalBody.html(data);
			//DataTable plugin 적용
			$('#itemList').DataTable({
		        "paging": true,
		        "lengthChange": false,
		        "searching": true,
		        "ordering": true,
		        "info": true,
		        "autoWidth": false,
		        "responsive": true,
			});
			modalObj.modal('show');
		})
		.fail(function( jqXHR, textStatus ) {
			Toast.fire({
				icon: 'warning',
				title: "Request failed: " + textStatus
			});
		});
	});
	
	//비용 거래명세서 Modal
	
	
	/****************************
			  모달 → 자동입력
	****************************/
	//거래처정보
	$(document).on('click', '#clientList .selectBtn', function(){
		clientCode.val($(this).parents('tr').children().eq(0).text()); //거래처코드
		businessName.val($(this).parents('tr').children().eq(2).text()); //거래처명
		modalObj.modal('hide');
	});
	//자재발주내역
	$(document).on('click', '#materialOrderList .selectBtn', function(){
		materialOrderCode.val($(this).parents('tr').children().eq(0).text()); //자재발주코드
		contractCode.val($(this).parents('tr').children().eq(1).text()); //계약코드
		clientCode.val($(this).parents('tr').children().eq(2).text()); //거래처코드
		businessName.val($(this).parents('tr').children().eq(3).text()); //거래처명
		briefs.val($(this).parents('tr').children().eq(7).text()); //적요
		requestDate.val($(this).parents('tr').children().eq(9).text()); //주문일자
		modalObj.modal('hide');
	});
	//창고목록
	$(document).on('click', '#warehouseList .selectBtn', function(){
		receiveWarehouse.val($(this).parents('tr').children().eq(0).text()); //창고코드
		receiveWarehouseName.val($(this).parents('tr').children().eq(1).text()); //창고명
		console.log($(this).parents('tr').children().eq(5).text());
		receiveWarehouseLocation.val($(this).parents('tr').children().eq(5).text()); //위치(소재지)
		modalObj.modal('hide');
	});
	//회원정보
	$(document).on('click', '#userList .selectBtn', function(){
		managerId.val($(this).parents('tr').children().eq(0).text());
		managerName.val($(this).parents('tr').children().eq(1).text());
		modalObj.modal('hide');
	});
	//품목정보
	
	//비용 거래명세서
	
	/****************************
				FORM
	****************************/
	//데이터 전송
	$(document).on('click', '#submitBtn', function(){
		//유효성 검사
		var chk = 0;
		if( clientCode.val() == null || clientCode.val() == '' ) {
			chk += 1;
		}else if( materialOrderCode.val() == null || materialOrderCode.val() == '' ) {
			chk += 1;
		}else if( receiveWarehouse.val() == null || receiveWarehouse.val() == '' ) {
			chk += 1;
		}else if( managerId.val() == null || managerId.val() == '' ) {
			chk += 1;
		}else if( totalWeight.val() == null || totalWeight.val() == 0 ) {
			chk += 1;
		}else if( totalPrice.val() == null || totalPrice.val() == 0 ) {
			chk += 1;
		}
		if(chk > 0) {
			Toast.fire({
				icon: 'error',
				title: '필수 작성 요소를 기입해주세요'
			});
		}else {
			//List<Stock> s
			$('#details .row').each(function(i, row){
			    $(row).find('input[name]').each(function(j, obj){
			    	$(obj).attr('name', 's['+i+'].'+$(obj).attr('data-details')).attr('name');
			    });
			});
			//addWarehousing.submit();
		}
	});
	
});
</script>
</th:block>
<th:block layout:fragment="customStyle"></th:block>

<th:block layout:fragment="SectionTitle">[[${SectionTitle}]]</th:block>
<th:block layout:fragment="SectionLocation">[[${SectionLocation}]]</th:block>

<th:block layout:fragment="customContents">

<form id="addWarehousing"th:action="@{/k1WarehousingAdd}" method="POST">
	<div class="container-fluid">
		<div class="row">
			<div class="col-lg-4">
				<div class="card card-info card-outline">
					<div class="card-header">
						<h3 class="card-title">자재입고내역  등록</h3>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="form-group col-lg-6">
								<label for="clientCode">
									거래처
								</label>
								<input type="hidden" id="clientCode" name="clientCode">
								<input type="text" id="businessName" class="form-control" placeholder="거래처 상호">
							</div>
							<!-- 자재발주내역 선택시 거래처/계약서 자동선택. 거래처 선택시 자재발주내역/계약서 씻음 -->
							<div class="form-group col-lg-3 col-sm-6">
								<label for="materialOrderCode">
									자재발주내역
								</label>
								<input type="text" id="materialOrderCode" name="materialOrderCode" class="form-control">
							</div>
							<div class="form-group col-lg-3 col-sm-6">
								<label for="contractCode">
									계약내역
								</label>
								<input type="text" id="contractCode" name="contractCode" class="form-control">
							</div>
						</div>
						<div class="row">
							<div class="form-group col-md-4">
								<label for="receiveWarehouse">
									입고창고
								</label>
								<input type="hidden" id="receiveWarehouse" name="receiveWarehouse" class="form-control">
								<input type="text" id="receiveWarehouseName" class="form-control" placeholder="창고명">
							</div>
							<div class="form-group col-md-4">
								<label for="receiveWarehouse">
									위치(소재지)
								</label>
								<input type="text" id="receiveWarehouseLocation" class="form-control" readonly>
							</div>
							<div class="form-group col-md-4">
								<label for="totalWeight">
									합계중량
								</label>
								<input type="number" id="totalWeight" class="form-control" readonly>
							</div>
						</div>
						<div class="row">
							<div class="form-group col-md-8">
								<label for="itemList">
									자재 목록
								</label>
								<input type="text" id="itemListInput" class="form-control" readonly>
							</div>
							<div class="form-group col-md-4">
								<label for="totalPrice">
									합계금액
								</label>
								<input type="text" id="totalPrice" class="form-control" readonly>
							</div>
						</div>
						<div class="row">
							<div class="form-group col-lg-8">
								<label for="briefs">
									적요
								</label>
								<input type="text" id="briefs" name="briefs" class="form-control" placeholder="적요를 입력하세요.">
							</div>
							<div class="form-group col-lg-4">
								<label for="managerId">
									담당자
								</label>
								<input type="hidden" id="managerId" name="managerId" class="form-control">
								<input type="text" id="managerName" class="form-control" placeholder="담당자">
							</div>
						</div>
						<div class="row">
							<div class="form-group col-sm-4">
								<label>요청일자</label>
								<div class="input-group date" id="requestDate" data-target-input="nearest">
									<input type="text" name="requestDate" class="form-control datetimepicker-input" data-target="#requestDate">
									<div class="input-group-append" data-target="#requestDate" data-toggle="datetimepicker">
										<div class="input-group-text"><i class="fa fa-calendar"></i></div>
									</div>
								</div>
							</div>
							<div class="form-group col-sm-4">
								<label>처리일자</label>
								<div class="input-group date" id="adjDate" data-target-input="nearest">
									<input type="text" name="adjDate" class="form-control datetimepicker-input" data-target="#adjDate">
									<div class="input-group-append" data-target="#adjDate" data-toggle="datetimepicker">
										<div class="input-group-text"><i class="fa fa-calendar"></i></div>
									</div>
								</div>
							</div>
							<div class="form-group col-sm-4">
								<label>완료일자</label>
								<div class="input-group date" id="endDate" data-target-input="nearest">
									<input type="text" name="endDate" class="form-control datetimepicker-input" data-target="#endDate">
									<div class="input-group-append" data-target="#endDate" data-toggle="datetimepicker">
										<div class="input-group-text"><i class="fa fa-calendar"></i></div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="card-footer">
						<a th:href="@{/k1Warehousing}">
							<button type="button" class="btn btn-default">목록으로</button>
						</a>
						<button type="button" id="submitBtn" class="btn btn-info float-right mr-2">등록하기</button>
					</div>
				</div>
			</div>
			<div class="col-lg-8">
				<div class="card card-info card-outline">
					<div class="card-header">
						<h3 class="card-title">자재입고 상세내역  등록</h3>
					</div>
					<div id="details" class="card-body">
						<div class="row">
							<div class="form-group float-left ml-2">
								<label>품목명</label>
								<input type="hidden" name="itemCode"
										th:value="${s == null} ? null : ${s.itemCode}" data-details="itemCode">
								<input type="text" class="form-control itemNameForm" placeholder="품목명"
										th:value="${s == null} ? null : ${s.itemName}">
							</div>
							<div class="form-group float-left ml-2">
								<label>비용</label>
								<input type="hidden" name="purchaseTsCode"
										th:value="${s == null} ? null : ${s.purchaseTsCode}" data-details="purchaseTsCode">
								<input type="number" class="form-control unitPriceForm">
							</div>
							<div class="form-group float-left ml-2">
								<label>입고수량</label>
								<input type="number" name="itemCount" class="form-control" data-details="itemCount">
							</div>
							<div class="form-group float-left ml-2">
								<label>입고중량</label>
								<input type="number" name="stockWeight" class="form-control" data-details="stockWeight">
							</div>
							<div class="form-group float-left ml-2">
								<label>비고</label>
								<input type="text" name="comment" class="form-control" placeholder="비고"
										th:value="${s == null} ? null : ${s.comment}" data-details="comment">
							</div>
							<div class="form-group float-left ml-2">
								<label>상태</label>
								<input type="text" name="status" class="form-control" placeholder="상태"
										th:value="${s == null} ? null : ${s.status}" data-details="status">
							</div>
							<div class="form-group float-right mr-2">
								<button type="button" class="btn btn-danger btn-sm float-right removeLine" style="margin-top:3px;">
									<i class="fas fa-trash-alt"></i>
								</button>
							</div>
						</div>
					</div>
					<div class="card-footer">
						<button type="button" class="btn btn-default btn-sm float-right" id="addLine">
							<i class="far fa-plus-square"></i>
						</button>
					</div>
				</div>
			</div>
		</div>
		
		<div class="modal fade" id="modalObj" style="display: none;" aria-hidden="true">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header text-center">
						<h5 class="modal-title"></h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">×</span>
						</button>
					</div>
					<div class="modal-body">
					
						<!-- INSERT HTML -->
					
					</div>
					<div class="modal-footer justify-content-between">
						<button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal-dialog -->
		</div>
	</div>
</form>
</th:block>

</html>